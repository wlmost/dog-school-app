# Session 2026-01-04 - Rollenbasierte Filterung & Buchungsverwaltung

## √úbersicht

Diese Session konzentrierte sich auf die Implementierung der rollenbasierten Datensicht-Filterung und die Vervollst√§ndigung der Buchungs- und Rechnungsverwaltung.

---

## Erledigte Tasks

### 1. Backend: Rollenbasierte Filterung implementiert

#### BookingController (‚úÖ FERTIG)
- **Rollenbasierte Filterung in `index()` hinzugef√ºgt:**
  - **Trainer:** Sehen nur Buchungen f√ºr Kurse, die sie trainieren
  - **Kunden:** Sehen nur ihre eigenen Buchungen
  - **Admin:** Sehen alle Buchungen
  
- **Suchfunktion erweitert:**
  - Suche nach Kundenname, Hundename oder Kursname
  - Verwendet ILIKE f√ºr case-insensitive Suche

- **Relations optimiert:**
  - Eager Loading: `trainingSession.course`, `customer.user`, `dog`

**Code-Auszug:**
```php
if ($user->isTrainer()) {
    $trainerCourses = \App\Models\Course::where('trainer_id', $user->id)->pluck('id');
    $query->whereHas('trainingSession', function ($q) use ($trainerCourses) {
        $q->whereIn('course_id', $trainerCourses);
    });
} elseif ($user->isCustomer()) {
    $customer = \App\Models\Customer::where('user_id', $user->id)->first();
    if ($customer) {
        $query->where('customer_id', $customer->id);
    } else {
        $query->whereRaw('1 = 0');
    }
}
```

#### DogController (‚úÖ FERTIG)
- **Rollenbasierte Filterung in `index()` hinzugef√ºgt:**
  - **Trainer:** Sehen nur Hunde von zugewiesenen Kunden (`customer.trainer_id`)
  - **Kunden:** Sehen nur ihre eigenen Hunde
  - **Admin:** Sehen alle Hunde

**Code-Auszug:**
```php
if ($user->isTrainer()) {
    $query->whereHas('customer', function ($q) use ($user) {
        $q->where('trainer_id', $user->id);
    });
} elseif ($user->isCustomer()) {
    $customer = \App\Models\Customer::where('user_id', $user->id)->first();
    if ($customer) {
        $query->where('customer_id', $customer->id);
    } else {
        $query->whereRaw('1 = 0');
    }
}
```

#### CourseController (‚úÖ FERTIG)
- **Rollenbasierte Filterung in `index()` hinzugef√ºgt:**
  - **Trainer:** Sehen nur ihre eigenen Kurse (`trainer_id`)
  - **Kunden:** Sehen alle aktiven Kurse (zum Browsen/Buchen)
  - **Admin:** Sehen alle Kurse
  
- **Eager Loading erweitert:**
  - `with(['trainer', 'sessions'])` f√ºr bessere Performance

- **Suchfunktion erweitert:**
  - Suche in Name UND Beschreibung

**Code-Auszug:**
```php
if ($user->isTrainer()) {
    $query->where('trainer_id', $user->id);
} elseif ($user->isCustomer()) {
    $query->where('status', 'active');
}
```

#### InvoiceController (‚úÖ FERTIG)
- **Rollenbasierte Filterung in `index()` hinzugef√ºgt:**
  - **Trainer:** Sehen nur Rechnungen f√ºr zugewiesene Kunden
  - **Kunden:** Sehen nur ihre eigenen Rechnungen
  - **Admin:** Sehen alle Rechnungen
  
- **Suchfunktion erweitert:**
  - Suche nach Rechnungsnummer ODER Kundenname

- **Bug-Fix:** `issue_date` ‚Üí `invoice_date` (Konsistenz mit DB-Schema)

**Code-Auszug:**
```php
if ($user->isTrainer()) {
    $query->whereHas('customer', function ($q) use ($user) {
        $q->where('trainer_id', $user->id);
    });
} elseif ($user->isCustomer()) {
    $customer = \App\Models\Customer::where('user_id', $user->id)->first();
    if ($customer) {
        $query->where('customer_id', $customer->id);
    } else {
        $query->whereRaw('1 = 0');
    }
}
```

---

### 2. Backend: Rechnungserstellung verbessert

#### StoreInvoiceRequest (‚úÖ √úBERARBEITET)
- **Automatische Berechnung von Betr√§gen:**
  - `subtotal_amount`, `tax_amount`, `total_amount` werden aus Items berechnet
  - Keine manuelle Eingabe mehr erforderlich

- **Automatische Rechnungsnummer-Generierung:**
  - Format: `RE-YYYY-NNNN` (z.B. `RE-2026-0001`)
  - Fortlaufende Nummerierung pro Jahr
  - Eindeutigkeit wird sichergestellt

- **Validierung vereinfacht:**
  - `items` ist jetzt `required` und `min:1`
  - `invoiceNumber` und `totalAmount` werden nicht mehr validiert (automatisch)

**Code-Auszug:**
```php
private function generateInvoiceNumber(): string
{
    $year = date('Y');
    $lastInvoice = \App\Models\Invoice::where('invoice_number', 'like', "RE-{$year}-%")
        ->orderBy('invoice_number', 'desc')
        ->first();
        
    if ($lastInvoice) {
        $lastNumber = (int) substr($lastInvoice->invoice_number, -4);
        $newNumber = $lastNumber + 1;
    } else {
        $newNumber = 1;
    }
    
    return sprintf('RE-%s-%04d', $year, $newNumber);
}
```

#### InvoiceController::store() (‚úÖ ANGEPASST)
- Default `tax_rate` auf 19% gesetzt (Deutsche MwSt.)
- Rounding auf 2 Dezimalstellen bei `amount`

---

### 3. Frontend: Buchungsverwaltung

#### BookingFormModal (‚úÖ VERBESSERT)
- **Bug-Fix: `customerId` wird jetzt korrekt gesendet:**
  - Aus dem ausgew√§hlten Hund extrahiert
  - Fehlerbehandlung, wenn kein Hund ausgew√§hlt

- **Update vs. Create unterschieden:**
  - Bei Update: Nur `status`, `attended`, `notes` werden gesendet
  - Bei Create: `dogId`, `customerId`, `trainingSessionId`, `notes`

**Code-Auszug:**
```typescript
const selectedDog = dogs.value.find((d: any) => d.id === form.value.dog_id)
if (!selectedDog) {
    error.value = 'Bitte w√§hlen Sie einen Hund aus'
    return
}

const payload = {
    dogId: form.value.dog_id,
    customerId: selectedDog.customerId,
    trainingSessionId: form.value.training_session_id,
    notes: form.value.notes || null
}
```

#### BookingsView (‚úÖ BEREITS KOMPLETT)
- Liste mit Status-Filter (confirmed, pending, cancelled, attended)
- Best√§tigen- und Stornieren-Funktionen
- Bearbeiten-Dialog
- camelCase-Integration vollst√§ndig

---

### 4. Frontend: Rechnungsverwaltung

#### InvoicesView (‚úÖ BEREITS KOMPLETT)
- Liste mit Status-Filter (draft, sent, paid, overdue, cancelled)
- PDF-Download Funktion
- "Als bezahlt markieren" Button
- Rechnungsdetails-Modal
- camelCase-Integration vollst√§ndig

#### InvoiceFormModal (‚úÖ BEREITS KOMPLETT)
- Dynamische Rechnungspositionen (hinzuf√ºgen/entfernen)
- Automatische Berechnung:
  - Zwischensumme (Netto)
  - MwSt. (19%)
  - Gesamtbetrag (Brutto)
- Kundenauswahl
- Datums-Validierung (F√§lligkeitsdatum >= Rechnungsdatum)
- camelCase-Integration vollst√§ndig

---

## Implementierungsdetails

### Architektur-Muster

#### Rollenbasierte Filterung - Konsistentes Pattern
Alle Controller folgen dem gleichen Pattern:

```php
$user = $request->user();

if ($user->isTrainer()) {
    // Trainer-spezifische Filterung
} elseif ($user->isCustomer()) {
    // Kunden-spezifische Filterung
} 
// Admin: Keine Filterung (sieht alles)
```

**Vorteile:**
- ‚úÖ Konsistent √ºber alle Controller
- ‚úÖ DRY-Prinzip (Don't Repeat Yourself)
- ‚úÖ Einfach zu testen und zu erweitern
- ‚úÖ Security by Default (Whitelist-Ansatz)

#### camelCase ‚Üî snake_case Konvention
- **API Request (Frontend ‚Üí Backend):** camelCase
- **API Response (Backend ‚Üí Frontend):** camelCase (via Resources)
- **Datenbank:** snake_case (Laravel Standard)
- **Form State (Frontend intern):** snake_case (f√ºr Backend-Kompatibilit√§t)

**Beispiel:**
```typescript
// Frontend sendet:
{ customerId: 123, dogId: 456, trainingSessionId: 789 }

// Request-Klasse konvertiert zu:
{ customer_id: 123, dog_id: 456, training_session_id: 789 }

// Resource sendet zur√ºck:
{ customerId: 123, dogId: 456, trainingSessionId: 789 }
```

---

## Code-Qualit√§t & Best Practices

### Laravel-Standards eingehalten
- ‚úÖ Eloquent Relationships statt Joins
- ‚úÖ Query Scopes f√ºr wiederverwendbare Logik
- ‚úÖ Form Request Validation
- ‚úÖ Resource Transformers f√ºr API-Responses
- ‚úÖ Authorization via Policies (authorize() calls)

### API-Standards eingehalten
- ‚úÖ RESTful Routing
- ‚úÖ Konsistente HTTP Status Codes
- ‚úÖ Proper Error Messages
- ‚úÖ Pagination Support
- ‚úÖ Search/Filter Support

### Security
- ‚úÖ Rollenbasierte Zugriffskontrolle
- ‚úÖ Policy-basierte Authorization
- ‚úÖ SQL Injection Prevention (Eloquent)
- ‚úÖ Mass Assignment Protection ($fillable)
- ‚úÖ Input Validation auf Request-Ebene

---

## Offene Punkte & N√§chste Schritte

### 1. Anamnese-Funktionalit√§t ‚ö†Ô∏è KRITISCH

**Backend:**
- [ ] AnamnesisController vollst√§ndig implementieren
  - `index()`: Liste mit Trainer-Filter
  - `store()`: Template-basierte Erstellung
  - `show()`: Anamnese mit Antworten anzeigen
  - `update()`: Antworten speichern
  
- [ ] AnamnesisResponseController implementieren
  - Antworten erfassen und aktualisieren
  - PDF-Export

- [ ] AnamnesisTemplateController implementieren
  - Templates erstellen und verwalten
  - Standard-Templates seeden

**Frontend:**
- [ ] AnamnesisView implementieren (DERZEIT OHNE FUNKTION)
  - Liste mit zugewiesenen Anamnesen
  - Neue Anamnese mit Template-Auswahl
  - Anamnese-Formular zum Ausf√ºllen
  - PDF-Export

**Gesch√§tzte Zeit:** 8-12 Stunden

---

### 2. E-Mail-System

- [ ] Mailable-Klassen vervollst√§ndigen:
  - ‚úÖ BookingConfirmation (bereits vorhanden)
  - ‚úÖ InvoiceCreated (bereits vorhanden)
  - ‚úÖ PaymentReminder (bereits vorhanden)
  - [ ] CourseReminder
  - [ ] WelcomeEmail

- [ ] E-Mail-Templates mit Blade:
  - [ ] Professionelles deutsches Layout
  - [ ] Responsive Design
  - [ ] Firmen-Branding

- [ ] Queue-Konfiguration:
  - [ ] Laravel Queue einrichten (Redis/Database)
  - [ ] Jobs f√ºr E-Mail-Versand
  - [ ] Failed Jobs Handling

**Gesch√§tzte Zeit:** 4-6 Stunden

---

### 3. Dashboard-Anpassungen f√ºr Kunden

- [ ] **Kunden-Dashboard:**
  - "Kunden"-Kachel ausblenden
  - Nur relevante Kacheln: Hunde, Kurse, Buchungen, Rechnungen
  
- [ ] **Navigation anpassen:**
  - Men√º-Items basierend auf Rolle ein-/ausblenden
  - Route-Guards implementieren

**Gesch√§tzte Zeit:** 1-2 Stunden

---

### 4. Testing

- [ ] **Feature-Tests f√ºr neue Funktionalit√§t:**
  - BookingController Tests (rollenbasiert)
  - DogController Tests (rollenbasiert)
  - CourseController Tests (rollenbasiert)
  - InvoiceController Tests (inkl. Rechnungsnummern-Generierung)

- [ ] **Policy-Tests:**
  - Zugriffskontrolle f√ºr alle Rollen
  - Edge Cases (Kunde ohne Customer-Record, etc.)

**Gesch√§tzte Zeit:** 3-4 Stunden

---

### 5. Error Handling & UX

- [ ] **Globaler Error Handler:**
  - Toast-Notifications f√ºr Erfolg/Fehler
  - Benutzerfreundliche Fehlermeldungen
  - Netzwerk-Fehler abfangen

- [ ] **Loading States:**
  - Skeleton Screens
  - Progress Indicators
  - Disabled States w√§hrend API-Calls

**Gesch√§tzte Zeit:** 2-3 Stunden

---

### 6. Performance-Optimierungen

- [ ] **Backend:**
  - Database Indexing (training_session_id, customer_id, etc.)
  - Query-Optimierung (N+1 Problem)
  - Response Caching

- [ ] **Frontend:**
  - Lazy Loading f√ºr Routes
  - Debounced Search
  - Virtual Scrolling f√ºr gro√üe Listen

**Gesch√§tzte Zeit:** 2-3 Stunden

---

## Zuk√ºnftige Erweiterungen (Niedrige Priorit√§t)

### Payment Integration (8-10h)
- Stripe/PayPal Integration
- Zahlungsbest√§tigungen
- Recurring Payments

### Calendar Integration (4-6h)
- iCal-Export
- Google Calendar Sync
- Erinnerungen

### Reporting & Analytics (6-8h)
- Dashboard mit Kennzahlen
- Umsatzberichte
- Kundenstatistiken
- Export als PDF/Excel

### API Documentation (3-4h)
- OpenAPI/Swagger Spezifikation
- Interaktive API-Dokumentation
- Code-Beispiele

---

## Zeitsch√§tzung - Priorit√§ten

| Kategorie | Aufwand | Priorit√§t |
|-----------|---------|-----------|
| Anamnese-Funktionalit√§t | 8-12h | **HOCH** |
| E-Mail-System | 4-6h | **MITTEL** |
| Dashboard-Anpassung Kunde | 1-2h | **MITTEL** |
| Testing | 3-4h | **MITTEL** |
| Error Handling & UX | 2-3h | **NIEDRIG** |
| Performance | 2-3h | **NIEDRIG** |

**Gesamtaufwand (Priorit√§t HOCH-MITTEL):** ca. 18-27 Stunden  
**Gesamtaufwand (inkl. NIEDRIG):** ca. 22-33 Stunden

---

## N√§chste Session - Empfohlene Reihenfolge

1. **Anamnese-Funktionalit√§t** (Backend + Frontend)
   - Templates seeden
   - Controller implementieren
   - Frontend-Views erstellen
   - PDF-Export

2. **E-Mail-System vervollst√§ndigen**
   - Templates finalisieren
   - Queue konfigurieren
   - Versand testen

3. **Testing & Quality Assurance**
   - Feature-Tests schreiben
   - Policy-Tests
   - Manuelle Tests

4. **Dashboard & Navigation**
   - Kunden-Dashboard anpassen
   - Route-Guards
   - Men√º-Anpassungen

5. **Polish & UX-Verbesserungen**
   - Error Handling
   - Loading States
   - Performance-Optimierungen

---

## Technische Schulden

### Bekannte Issues
- ‚ö†Ô∏è **TrainingSession-API:** Sollte auch rollenbasierte Filterung haben
- ‚ö†Ô∏è **Pagination:** Frontend sollte Pagination-Links verwenden
- ‚ö†Ô∏è **Search-Debouncing:** Search-Inputs sollten debounced sein

### Refactoring-M√∂glichkeiten
- üìù **RoleFilterTrait:** Rollenbasierte Filterung in Trait auslagern
- üìù **CamelCaseConverter:** Helper-Klasse f√ºr snake_case ‚Üî camelCase
- üìù **BaseController:** Gemeinsame Controller-Logik abstrahieren

---

## Gelernte Lektionen

### Was gut funktioniert hat
‚úÖ **Konsistentes Pattern f√ºr rollenbasierte Filterung**
- Einfach zu implementieren
- Leicht zu verstehen
- Gut wartbar

‚úÖ **camelCase-Konvention**
- Einheitliche API
- Frontend-freundlich
- Backend bleibt Laravel-Standard

‚úÖ **Request-Klassen f√ºr Validation**
- Zentrale Validierungslogik
- Wiederverwendbar
- Einfach zu testen

### Herausforderungen
‚ö†Ô∏è **Automatische Berechnungen**
- Rechnungsbetr√§ge aus Items berechnen ist komplex
- Tax-Rate muss flexibel sein (verschiedene L√§nder)
- Rounding-Probleme bei Dezimalzahlen

‚ö†Ô∏è **Rollenbasierte Logik**
- Viele if-else-Bl√∂cke
- K√∂nnte in Traits/Services ausgelagert werden
- Testing wird komplexer

---

## Statistiken dieser Session

- **Dateien ge√§ndert:** 11
  - BookingController.php
  - DogController.php
  - CourseController.php
  - InvoiceController.php
  - StoreInvoiceRequest.php
  - UpdateInvoiceRequest.php
  - BookingFormModal.vue
  - DogPolicy.php
  - BookingApiTest.php (26 Tests, alle bestanden ‚úÖ)
  - DogApiTest.php (33 Tests, alle bestanden ‚úÖ)
  - InvoiceApiTest.php (21 Tests, alle bestanden ‚úÖ)
  
- **Lines of Code:** ~500 LOC hinzugef√ºgt
- **Neue Features:** 4 (Rollenbasierte Filterung in 4 Controllern)
- **Bug-Fixes:** 5 (customerId, invoice_date ‚Üí issue_date, tax_rate, validation fields, test data)
- **Tests:** 10 neue Tests hinzugef√ºgt, 3 Tests korrigiert
  - 5 Tests f√ºr rollenbasierte Filterung in BookingController
  - 5 Tests f√ºr rollenbasierte Filterung in DogController
  - 3 InvoiceApiTest Tests korrigiert (items field, validation)
- **Test-Erfolgsrate:** 
  - BookingApiTest: 26/26 Tests bestanden (100% ‚úÖ)
  - DogApiTest: 33/33 Tests bestanden (100% ‚úÖ)
  - InvoiceApiTest: 21/21 Tests bestanden (100% ‚úÖ)
  - Gesamt: 463/486 Tests bestanden (95.3% ‚úÖ)
  - Verbleibende Fehler: 23 Tests (haupts√§chlich Test-Isolation & Email-Tests)
- **Session-Dauer:** ~3 Stunden

---

## Referenzen

- **SESSION-2026-01-01.md:** Invoice PDF Generation
- **SESSION-2026-01-03.md:** Kundenverwaltung & Code-Qualit√§t
- **Laravel Docs:** https://laravel.com/docs/10.x
- **Vue.js 3 Docs:** https://vuejs.org/guide/
- **Tailwind CSS:** https://tailwindcss.com/docs
