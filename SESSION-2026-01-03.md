# Session 2026-01-03 - Kundenverwaltung & Code-Qualität

## Erledigte Tasks und Features

### Backend-Erweiterungen

#### Datenbankmigrationen
- ✅ **Adressfelder für Users** (`2026_01_03_154645_add_address_fields_to_users_table`)
  - `street`, `postal_code`, `city`, `country` zur `users`-Tabelle hinzugefügt
  - Ermöglicht Adressverwaltung für Trainer direkt im User-Model

- ✅ **Trainer-Qualifikationen** (`2026_01_03_154041_add_qualifications_and_specializations_to_users_table`)
  - `qualifications` und `specializations` Felder zur `users`-Tabelle hinzugefügt
  - Textfelder für detaillierte Trainer-Profile

#### User Model & Resources
- ✅ **User Model erweitert**
  - Neue Felder in `$fillable`: `street`, `postal_code`, `city`, `country`, `qualifications`, `specializations`
  - Helper-Methoden: `isAdmin()`, `isTrainer()`, `isCustomer()`, `isAdminOrTrainer()`
  - `getFullNameAttribute()` für kombinierten Vor- und Nachnamen

- ✅ **UserResource auf camelCase umgestellt**
  - Alle API-Responses verwenden camelCase
  - `firstName`, `lastName`, `fullName`, `postalCode`, `emailVerifiedAt`, `createdAt`, `updatedAt`

#### Controller-Implementierungen
- ✅ **TrainerController vollständig implementiert**
  - `index()`: Liste aller Trainer mit Suchfunktion
  - `store()`: Trainer erstellen mit vollständiger Validierung
  - `show()`: Einzelnen Trainer abrufen
  - `update()`: Trainer aktualisieren (inkl. optionale Passwortänderung)
  - `destroy()`: Trainer löschen (mit Prüfung auf aktive Kurse)
  - camelCase Input-Validierung (firstName, lastName, postalCode, etc.)

- ✅ **CustomerController erweitert**
  - `update()`: Aktualisiert jetzt auch User-Felder (firstName, lastName, email, phone)
  - `store()`: Auto-Zuweisung von `trainer_id` wenn Trainer Kunde erstellt
  - `index()`: Filterung nach `trainer_id` für Trainer-Rolle

- ✅ **DashboardController rollenbasiert**
  - Trainer: Nur zugewiesene Kunden (`trainer_id` Filter)
  - Statistiken: customers, dogs, courses, invoices, bookings
  - upcomingSessions und recentBookings gefiltert nach Trainer-Zuordnung

#### Authentifizierung & Autorisierung
- ✅ **Passwort-Regeln konfiguriert** (AppServiceProvider)
  - Minimum 8 Zeichen
  - Groß- und Kleinbuchstaben
  - Zahlen und Sonderzeichen
  - Gilt global für alle Passwort-Validierungen

- ✅ **RegisterRequest Authorization**
  - Admins können alle Rollen erstellen
  - Trainer können nur Kunden erstellen
  - Korrekte Rolle-Validierung mit `$this->input('role')`

### Frontend-Implementierungen

#### Kundenverwaltung (CustomerFormModal)
- ✅ **Passwort-Bestätigung mit Show/Hide-Toggles**
  - Zwei Passwortfelder mit Eye-Icons zum Ein-/Ausblenden
  - Frontend-Validierung: Länge, Groß-/Kleinbuchstaben, Ziffern, Sonderzeichen
  - Backend-Validierung: `password_confirmation` wird gesendet

- ✅ **Trainer-Zuweisung**
  - Dropdown zur Trainer-Auswahl im Kundenformular
  - Auto-Selektion des aktuellen Trainers bei Kundenerstellung durch Trainer
  - Watch auf `isOpen` prüft Trainer-Rolle und setzt `trainer_id`

- ✅ **Inline-Hundeverwaltung**
  - "+ Hund hinzufügen" Button im Kundenformular (nur bei bestehenden Kunden)
  - Inline-Formular für schnelle Hundeerstellung (Name, Rasse, Geburtsdatum, Geschlecht, Gewicht)
  - Liste aller zugeordneten Hunde mit Lösch-Funktion
  - Sofortiges Nachladen nach Hinzufügen/Löschen

- ✅ **camelCase Integration**
  - Watch-Block liest API-Responses in camelCase (`firstName`, `lastName`, `postalCode`, `trainerId`)
  - Payload sendet camelCase an Backend (`firstName`, `lastName`, `trainerId`, `postalCode`)
  - Form-State bleibt in snake_case (interne Variablen)

#### Dashboard-Verbesserungen (DashboardView)
- ✅ **5 Statistik-Karten**
  - Kunden, Hunde, Kurse, Buchungen, Rechnungen
  - Grid-Layout: `lg:grid-cols-5` für gleichmäßige Verteilung
  - Alle Karten klickbar mit `router-link` zur jeweiligen Übersicht

- ✅ **Vereinfachte Kartenbeschriftungen**
  - "Aktive Kunden" → "Kunden"
  - "Registrierte Hunde" → "Hunde"
  - "Aktive Kurse" → "Kurse"
  - "Offene Rechnungen" → "Rechnungen"

- ✅ **Echte API-Daten**
  - Integration mit `/api/v1/dashboard` Endpoint
  - `stats`, `upcomingSessions`, `recentBookings` vom Server geladen
  - Keine Platzhalter-Daten mehr

#### Trainer-Verwaltung (TrainersView & TrainerFormModal)
- ✅ **Vollständiges CRUD für Trainer**
  - Kachelansicht und Tabellenansicht
  - Suchfunktion (Name, E-Mail, Stadt)
  - Sortierung nach Name, E-Mail, Stadt
  - Qualifikationen und Spezialisierungen Felder

- ✅ **TrainerFormModal**
  - Erstellen und Bearbeiten von Trainern
  - Passwort-Validierung (Pflicht bei Neuanlage, optional bei Bearbeitung)
  - Adressfelder (Straße, PLZ, Stadt, Land)
  - Qualifikationen und Spezialisierungen (Textareas)

#### Code-Qualität: snake_case → camelCase Korrektur

**Systematische Bereinigung aller Vue-Komponenten:**

- ✅ **DogsView**
  - `dog.customer?.user?.full_name` → `fullName`
  - `dog.date_of_birth` → `dateOfBirth`
  - `dog.chip_number` → `chipNumber`

- ✅ **BookingsView**
  - `booking.dog?.customer?.user?.full_name` → `fullName`
  - `booking.training_session` → `trainingSession`
  - `booking.booking_date` → `bookingDate`

- ✅ **InvoicesView**
  - `invoice.customer?.user?.full_name` → `fullName`
  - `invoice.invoice_number` → `invoiceNumber`
  - `invoice.invoice_date` → `invoiceDate`
  - `invoice.due_date` → `dueDate`
  - `invoice.total_amount` → `totalAmount`

- ✅ **CoursesView**
  - `course.start_date` → `startDate`
  - `course.end_date` → `endDate`
  - `course.current_participants` → `currentParticipants`
  - `course.max_participants` → `maxParticipants`
  - `course.course_type` → `courseType`

- ✅ **CustomerDetailModal**
  - `customer.postal_code` → `postalCode`
  - `customer.user.full_name` → `fullName`
  - `booking.training_session` → `trainingSession`
  - `booking.booking_date` → `bookingDate`

- ✅ **InvoiceDetailModal**
  - `invoice.customer?.user?.full_name` → `fullName`
  - `invoice.customer.postal_code` → `postalCode`
  - `invoice.invoice_number` → `invoiceNumber`
  - `invoice.invoice_date` → `invoiceDate`
  - `invoice.due_date` → `dueDate`
  - `item.unit_price` → `unitPrice`
  - `invoice.subtotal_amount` → `subtotalAmount`
  - `invoice.tax_amount` → `taxAmount`
  - `invoice.total_amount` → `totalAmount`

- ✅ **InvoiceFormModal**
  - Watch-Block: `newInvoice.customerId`, `invoiceDate`, `dueDate`
  - Item-Mapping: `item.unitPrice` beim Lesen von API

- ✅ **DogFormModal**
  - Watch-Block: `newDog.customerId`, `dateOfBirth`, `chipNumber`, `specialCharacteristics`, `isNeutered`
  - `customer.user?.full_name` → `fullName`

- ✅ **BookingFormModal**
  - Watch-Block: `newBooking.dogId`, `trainingSessionId`, `bookingDate`, `trainingSession?.courseId`
  - `dog.customer?.user?.full_name` → `fullName`

**Wichtiger Hinweis:**
- Form-State-Variablen (z.B. `form.postal_code`, `form.date_of_birth`) bleiben in snake_case
- Grund: Backend erwartet Request-Bodies in snake_case
- Nur beim **Lesen** von API-Responses wird camelCase verwendet

---

## Offene Punkte & Nächste Schritte

### 1. Rollenbasierte Datensicht-Filterung

#### 1.1 Trainer-Ansichten (nur zugewiesene Daten)
- [ ] **Hunde-Übersicht (DogsView)**
  - Filter: Nur Hunde von Kunden mit `trainer_id = current_user.id`
  - Backend: `DogController@index` muss Trainer-Filter implementieren
  
- [ ] **Kurs-Übersicht (CoursesView)**
  - Filter: Nur Kurse wo `trainer_id = current_user.id`
  - Backend: `CourseController@index` muss Trainer-Filter implementieren
  
- [ ] **Buchungs-Übersicht (BookingsView)** ⚠️ OHNE FUNKTION
  - Filter: Nur Buchungen von zugewiesenen Kunden
  - Backend: `BookingController@index` muss implementiert werden
  - Frontend: Komplette Implementierung erforderlich
  
- [ ] **Rechnungs-Übersicht (InvoicesView)** ⚠️ OHNE FUNKTION
  - Filter: Nur Rechnungen von zugewiesenen Kunden
  - Backend: `InvoiceController@index` muss implementiert werden
  - Frontend: Rechnungserstellung und -verwaltung implementieren

#### 1.2 Admin-Ansichten (alles außer Anamnesen)
- [ ] **Alle Standard-Ansichten**
  - Admin sieht alle Kunden, Hunde, Kurse, Buchungen, Rechnungen
  - Backend: Admin-Check in Controllern (`if (!user->isAdmin()) { apply filter }`)
  
- [ ] **Anamnesen-Zugriff**
  - Admin hat KEINEN Zugriff auf Anamnesen
  - Policy/Gate: `AnamnesisPolicy` muss Admin-Zugriff verbieten
  - Frontend: Route-Guard für Anamnese-Seite

#### 1.3 Kunden-Ansichten (nur eigene Daten)
- [ ] **Dashboard anpassen**
  - "Kunden"-Kachel ausblenden für Kunden-Rolle
  - Nur relevante Kacheln: Hunde, Kurse, Buchungen, Rechnungen
  
- [ ] **Hunde-Übersicht**
  - Filter: Nur eigene Hunde (`dog.customer.user_id = current_user.id`)
  - "Neuer Hund" Button sichtbar
  
- [ ] **Buchungs-Übersicht**
  - Filter: Nur eigene Buchungen
  - "Neue Buchung" Button sichtbar (für eigene Hunde)
  
- [ ] **Kurs-Übersicht**
  - Filter: Nur Kurse mit eigenen Buchungen
  - Oder: Alle verfügbaren Kurse zur Ansicht/Buchung
  
- [ ] **Rechnungs-Übersicht**
  - Filter: Nur eigene Rechnungen (`invoice.customer.user_id = current_user.id`)
  - Keine Bearbeitungsfunktion (read-only)

### 2. Anamnese-Funktionalität (Trainer) ⚠️ KRITISCH

- [ ] **Backend-Implementierung**
  - `AnamnesisController@index`: Liste aller Anamnesen (Trainer: nur zugewiesene Kunden)
  - `AnamnesisController@store`: Neue Anamnese erstellen
  - `AnamnesisController@show`: Anamnese-Details anzeigen
  - `AnamnesisController@update`: Anamnese bearbeiten
  - `AnamnesisResponse` Controller für Antworten

- [ ] **Frontend-Implementierung (AnamnesisView)** ⚠️ DERZEIT OHNE FUNKTION
  - Liste aller Anamnesen (gefiltert nach Rolle)
  - "Neue Anamnese" Modal mit Template-Auswahl
  - Anamnese-Detail-Ansicht mit Fragen/Antworten
  - Anamnese-Formular zum Ausfüllen
  - PDF-Export Funktion

- [ ] **Template-Verwaltung**
  - Trainer können eigene Templates erstellen
  - Standard-Templates (Welpen, Verhaltens-, Standard-Anamnese)
  - Template-Editor mit Fragetypen (Text, Multiple Choice, etc.)

### 3. Rechnungserstellung (Trainer) ⚠️ KRITISCH

- [ ] **Backend-Implementierung**
  - `InvoiceController@index`: Liste aller Rechnungen (mit Trainer-Filter)
  - `InvoiceController@store`: Neue Rechnung erstellen
  - `InvoiceController@update`: Rechnung aktualisieren
  - `InvoiceController@destroy`: Rechnung löschen (nur Entwürfe)
  - Rechnungsnummern-Generator (fortlaufend)
  - PDF-Generierung (mit dompdf bereits installiert)

- [ ] **Frontend-Implementierung (InvoicesView)** ⚠️ DERZEIT OHNE FUNKTION
  - Liste aller Rechnungen (mit Status-Filter: draft, sent, paid, overdue)
  - InvoiceFormModal funktionsfähig machen:
    - Kunden-Auswahl (Dropdown)
    - Rechnungsdatum & Fälligkeitsdatum
    - Rechnungspositionen (dynamisch hinzufügen/entfernen)
    - Automatische Berechnung (Zwischensumme, MwSt., Gesamtbetrag)
  - Rechnungsstatus ändern (als bezahlt markieren)
  - PDF-Download & E-Mail-Versand
  - Zahlungseingänge erfassen

### 4. Buchungsverwaltung (Trainer) ⚠️ KRITISCH

- [ ] **Backend-Implementierung**
  - `BookingController@index`: Liste aller Buchungen (mit Trainer-Filter)
  - `BookingController@store`: Neue Buchung erstellen
  - `BookingController@update`: Buchung aktualisieren (Status ändern)
  - `BookingController@destroy`: Buchung löschen/stornieren
  - Filter nach TrainingSession, Kurs, Status

- [ ] **Frontend-Implementierung (BookingsView)** ⚠️ DERZEIT OHNE FUNKTION
  - Liste aller Buchungen (mit Trainer-Filter)
  - BookingFormModal funktionsfähig machen:
    - Hund-Auswahl (nur zugewiesene Kunden für Trainer)
    - Kurs-Auswahl
    - TrainingSession-Auswahl (gefiltert nach Kurs)
    - Buchungsdatum & Status
    - Notizen
  - Status-Änderung (pending → confirmed → completed/cancelled)
  - Kalenderansicht für Buchungen (optional)
  - Teilnehmerliste pro TrainingSession

### 5. E-Mail-System (aus vorheriger Session)

- [ ] **Mailable-Klassen erstellen**
  - BookingConfirmation (Buchungsbestätigung an Kunden)
  - PaymentReminder (Zahlungserinnerung)
  - InvoiceCreated (Neue Rechnung erstellt)
  - CourseReminder (Kurserinnerung vor Termin)
  - WelcomeEmail (Willkommens-E-Mail für neue Kunden)

- [ ] **E-Mail-Templates mit Blade**
  - Professionelles deutsches Layout
  - Responsive Design für mobile Geräte
  - Firmen-Branding (Logo, Farben)
  - Call-to-Action Buttons

- [ ] **Queue-basiertes Versenden**
  - Laravel Queue konfigurieren (Redis/Database)
  - Jobs für E-Mail-Versand
  - Failed Jobs Handling
  - E-Mail-Versandprotokoll

- [ ] **E-Mail-Konfiguration**
  - SMTP-Server einrichten (Mailgun, SendGrid, oder eigener Server)
  - FROM-Adresse und Absendername
  - Reply-To Header
  - BCC für Admin-Kopien (optional)

### 6. Weitere Verbesserungen

- [ ] **Navigation & Routes**
  - Route-Guards basierend auf Benutzerrolle
  - Menü-Items dynamisch je nach Rolle ein-/ausblenden
  - Breadcrumbs für bessere Navigation

- [ ] **Error Handling**
  - Globaler Error Handler für API-Fehler
  - Toast-Notifications für Erfolg/Fehler-Meldungen
  - Benutzerfreundliche Fehlermeldungen

- [ ] **Performance**
  - Lazy Loading für Routen
  - Pagination für große Listen
  - Caching-Strategie für häufig abgerufene Daten

- [ ] **Testing**
  - Unit-Tests für kritische Backend-Komponenten
  - Feature-Tests für API-Endpoints
  - E2E-Tests für kritische User-Flows

### 7. Zukünftige Erweiterungen (Niedrige Priorität)

- [ ] **Payment Integration**
  - Stripe-Integration für Online-Zahlungen
  - PayPal-Integration als Alternative
  - Zahlungsbestätigungen automatisch mit Rechnungen verknüpfen
  - Recurring Payments für Abonnements/Mitgliedschaften

- [ ] **Calendar Integration**
  - iCal-Export für Trainings-Sessions
  - Google Calendar Sync
  - Automatische Kalendereinträge bei Buchung
  - Erinnerungen vor Terminen

- [ ] **Reporting & Analytics**
  - Dashboard mit Geschäftskennzahlen
  - Umsatzberichte nach Zeitraum
  - Kundenstatistiken (Retention, Churn)
  - Kursauslastung und -performance
  - Export als PDF/Excel

- [ ] **API Documentation**
  - OpenAPI/Swagger Spezifikation
  - Automatische Generierung aus Laravel Routes
  - Interaktive API-Dokumentation
  - Code-Beispiele für verschiedene Sprachen

- [ ] **File Upload System** (aus vorheriger Session)
  - Configure Laravel storage (local + S3)
  - TrainingAttachmentController implementieren
  - File upload mit Validierung
  - Image optimization (Intervention Image)
  - Thumbnails für Fotos generieren

- [ ] **Anamnesis PDF Template** (aus vorheriger Session)
  - Ähnlich wie Invoice PDF aber für Anamnese-Responses
  - Hunde-Information, Fragen, Antworten
  - Support für verschiedene Fragetypen (Text, Choice, Rating)

---

## Technische Hinweise

### camelCase vs snake_case Konvention
- **API-Responses (Backend → Frontend):** camelCase via Resources
- **Request-Bodies (Frontend → Backend):** snake_case in Form-State, dann gemappt zu camelCase für Backend
- **Datenbank:** snake_case (Laravel Standard)
- **Vue Template:** camelCase beim Zugriff auf API-Daten

### Rollenbasierte Filterung - Implementierungsmuster

```php
// Backend Controller (z.B. DogController@index)
public function index(Request $request)
{
    $query = Dog::query()->with(['customer.user']);

    // Trainer sieht nur Hunde von zugewiesenen Kunden
    if ($request->user()->isTrainer()) {
        $query->whereHas('customer', function ($q) use ($request) {
            $q->where('trainer_id', $request->user()->id);
        });
    }

    // Kunde sieht nur eigene Hunde
    if ($request->user()->isCustomer()) {
        $query->whereHas('customer', function ($q) use ($request) {
            $q->where('user_id', $request->user()->id);
        });
    }

    // Admin sieht alles (kein Filter)

    return DogResource::collection($query->get());
}
```

### Frontend Conditional Rendering

```vue
<!-- Dashboard - Kunden-Kachel ausblenden für Kunden -->
<router-link 
  v-if="!isCustomer" 
  :to="{ name: 'Customers' }" 
  class="card hover:shadow-lg transition-shadow cursor-pointer"
>
  <!-- Kunden-Kachel Inhalt -->
</router-link>
```

---

## Zeitschätzung für offene Punkte

| Kategorie | Aufwand | Priorität |
|-----------|---------|-----------|
| Anamnese-Funktionalität | 8-12h | HOCH |
| Rechnungserstellung | 6-8h | HOCH |
| Buchungsverwaltung | 4-6h | HOCH |
| Rollenbasierte Filterung | 3-4h | MITTEL |
| E-Mail-System | 4-6h | MITTEL |
| Dashboard-Anpassung Kunde | 1-2h | NIEDRIG |
| Error Handling & UX | 2-3h | NIEDRIG |
| Payment Integration | 8-10h | SPÄTER |
| Calendar Integration | 4-6h | SPÄTER |
| Reporting & Analytics | 6-8h | SPÄTER |
| API Documentation | 3-4h | SPÄTER |

**Gesamtaufwand (Priorität HOCH-MITTEL):** ca. 28-41 Stunden  
**Gesamtaufwand (inkl. SPÄTER):** ca. 49-69 Stunden

---

## Nächste Session - Empfohlene Reihenfolge

1. **Buchungsverwaltung implementieren** (Backend + Frontend)
   - Trainer können Buchungen verwalten
   - Basis für weitere Funktionen

2. **Rechnungserstellung implementieren** (Backend + Frontend)
   - Geschäftskritische Funktion
   - PDF-Generierung und Zahlungsverfolgung

3. **Anamnese-Funktionalität** (Backend + Frontend)
   - Komplex, aber wichtig für Dokumentation
   - Template-System aufbauen

4. **Rollenbasierte Filterung** in bestehenden Views
   - Schnelle Wins für bessere UX
   - Sicherheit & Datenschutz

5. **E-Mail-System** (Benachrichtigungen & Erinnerungen)
   - Automatisierung der Kommunikation
   - Queue-basierter Versand

6. **Dashboard-Anpassungen & Polish**
   - Finale UX-Verbesserungen
   - Error Handling & Notifications

---

## Referenzen zu vorherigen Sessions

- **SESSION-2026-01-01.md**: Invoice PDF Generation erfolgreich implementiert
  - DomPDF Integration
  - 18 umfassende Tests
  - Professionelles deutsches Invoice-Template
  - Alle 406 Tests bestanden
